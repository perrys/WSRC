<!DOCTYPE html>

<html>
<head>
  <link rel="stylesheet" href="/static/css/all_accounts.css">
  <script src="/static/js/all_admin_accounts.js"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <title>Account Management - Woking Squash Rackets Club</title>

  <script type="text/javascript">
jQuery(document).ready(function(){
  var categories = {{ categories_data|safe }};
  var accounts = {
{% for id, transaction_data in account_data.items %}
  {{ id }}: {{ transaction_data|safe }},
{% endfor %}
  };
  wsrc.admin.accounts.onReady(categories, accounts)
});
  google.load("visualization", "1.1", {packages:["line"]});
//  google.setOnLoadCallback(drawChart);
  </script>

</head>
{% load kwacros %}
{% load wsrc_utils %}
{% loadkwacros 'form_macros.html' %}

<body>
  <div id="tabs" class="initiallyHidden">
    <ul>
      <li><a href="#transactions_tab">Transactions</a></li>
      <li><a href="#analysis_tab">Anaysis</a></li>
      <li><a href="#upload_tab">Upload</a></li>
    </ul>

    <div id="transactions_tab" class="fixed-height-wrapper">
      <fieldset name="transactions" class="ui-corner-all">
        <legend>Summary</legend>
        <form action="#" method="GET">{% csrf_token %}
          <div class="information-table ui-corner-all">
            <table class="sortable-root">
              <thead>
                <tr class="header">
                  <th class="sortable" data-selector="td.category" data-sorter="lexical_sorter">Category</th>
                  <th>#&nbsp;Transactions</th>
                  <th>Incoming</th>
                  <th>Outgoing</th>
                  <th class="sortable" data-selector="td.net_total" data-sorter="numeric_sorter">Net</th>
                </tr>
              </thead>
              <tbody class="sortable-parent">
{% for category in categories %}
{% if not category.is_reconciling %}
                <tr data-id='{{ category.id }}'>
                  <td class='category'><input type='checkbox' onclick="wsrc.admin.accounts.on('update_transactions_table')"> {{ category.description }}</td>
                  <td class='count'> <td class='incoming'></td>
                  <td class='outgoing'></td>
                  <td class='net_total'></td>
                </tr>
{% endif %}
{% endfor %}
              </tbody>
              <tfoot>
                <tr data-id='total'>
                  <td class='category'><input type='checkbox' checked="checked" disabled="disabled"> All</td>
                  <td class='count'>
                  <td class='incoming'></td>
                  <td class='outgoing'></td>
                  <td class='net_total'></td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div class="ui-field-contain">
            <label for="transactions_account_selector">Account:</label>
            <select name="account" id="transactions_account_selector" class="ui-corner-all" onchange="wsrc.admin.accounts.on('update_transaction_and_summary_tables')">
{% for acc in accounts %}
              <option value="{{ acc.id }}" {% if account.id == acc.id %}selected="selected"{% endif %}>{{ acc.name }}</option>
{% endfor %}
            </select>
          </div>
          {% usekwacro createfield_adhoc "Start Date" "start_date" "transactions_start_date_input" "datepicker datepicker-three-months" "wsrc.admin.accounts.on('update_transaction_and_summary_tables')" %}
          {% usekwacro createfield_adhoc "End Date"   "end_date"   "transactions_end_date_input"   "datepicker datepicker-today" "wsrc.admin.accounts.on('update_transaction_and_summary_tables')" %}
          <div class="ui-field-contain">
            <label>Date Type:</label>
            <div class="radio-buttonset">
              <input name="transactions_date_type" id="transactions_cleared" type="radio" value="date_cleared" checked="checked" onchange="wsrc.admin.accounts.on('update_transaction_and_summary_tables')"><label for="transactions_cleared">Cleared</label>
              <input name="transactions_date_type" id="transactions_issued"  type="radio" value="date_issued" onchange="wsrc.admin.accounts.on('update_transaction_and_summary_tables')"><label for="transactions_issued">Issued</label>
            </div>
          </div>
          <div class="ui-field-contain">
            <label>First Date:</label>
            <div class="radio-buttonset">
              <input name="transactions_date_ordering" id="dates_descending" type="radio" value="descending" onchange="wsrc.admin.accounts.on('update_transaction_and_summary_tables')" checked="checked"><label for="dates_descending">Newest</label>
              <input name="transactions_date_ordering" id="dates_ascending"  type="radio" value="ascending" onchange="wsrc.admin.accounts.on('update_transaction_and_summary_tables')"><label for="dates_ascending">Oldest</label>
            </div>
          </div>
        </form>
      </fieldset>
      <div class="container">
        <table class="transactions sortable-root">
          <thead>
            <tr class="header">
              <th>Date Issued</th>
              <th>Date Cleared</th>
              <th>Bank Code</th>
              <th>Cheque #</th>
              <th>Bank Memo</th>
              <th>Comment</th>
              <th>Category</th>
              <th>Amount</th>
              <th>Balance</th>
            </tr>
          </thead>
          <tbody class="sortable-parent">
          </tbody>
        </table>
      </div>
    </div>

    <div id="analysis_tab">
      <div class="chart_div"></div>
    </div>

    <div id="upload_tab" class="fixed-height-wrapper">

{% if csv_data %}
      <form action="#" method="GET" onsubmit="return false;">{% csrf_token %}
        <fieldset name="file_upload" class="ui-corner-all">
          <legend>Transaction Upload</legend>
          <div class="information-set">
            {% usekwacro createfield_adhoc "# Transactions"   "transaction_count"   "upload_transaction_count_input" "readonly"%}
            {% usekwacro createfield_adhoc "# Uncategorized"   "uncategorized_count"   "upload_uncategorized_count_input" "errorfield readonly"%}
            {% usekwacro createfield_adhoc "Incoming"   "incoming"   "upload_incoming_input" "readonly"%}
            {% usekwacro createfield_adhoc "Outgoing"   "outgoing"   "upload_outgoing_input" "readonly"%}
          </div>
          {% usekwacro createfield_adhoc "Start Date" "start_date" "upload_start_date_input" "datepicker" "wsrc.admin.accounts.on('handle_upload_data_changed')" %}
          {% usekwacro createfield_adhoc "End Date"   "end_date"   "upload_end_date_input"   "datepicker" "wsrc.admin.accounts.on('handle_upload_data_changed')" %}
          <div class="ui-field-contain">
            <label for="upload_account_selector">Account:</label>
            <select name="account" id="upload_account_selector" >
{% for acc in accounts %}
              <option value="{{ acc.id }}">{{ acc.name }}</option>
{% endfor %}
            </select>
            <button id='upload_go_button' onclick="wsrc.admin.accounts.on('upload_transactions')" disabled='true'>Go</button>
          </div>
        </fieldset>
      </form>
{% else %}
      <form action="{% url 'wsrc.site.accounts.views.accounts_view' %}/#upload_tab" enctype="multipart/form-data" method="post">{% csrf_token %}
        <fieldset name="file_upload" class="ui-corner-all">
          <legend>File Upload</legend>
{% usekwacro createfield form.file True %}
          <div class="ui-field-contain">
            <label for="upload_account_selector">Account:</label>
            <select name="account" id="upload_account_selector" >
{% for acc in accounts %}
              <option value="{{ acc.id }}">{{ acc.name }}</option>
{% endfor %}
            </select>
          </div>
        </fieldset>
      </form>
{% endif %}
    <div class="container">
      <table class="transactions" id="transaction-upload-table">
        <thead>
          <tr class="header">
            <th>Date Issued</th>
            <th>Date Cleared</th>
            <th>Amount</th>
            <th>Bank Code</th>
            <th>Cheque #</th>
            <th>Bank Memo</th>
            <th>Comment</th>
            <th>Category</th>
            <th>Ignore</th>
          </tr>
        </thead>
        <tbody>
{% for row in csv_data %}
{% if row.Amount or row.Number %}
          <tr class="{% cycle '' 'alt' %} {% if  row.x_duplicate %}ignored{% endif %}">
            <td class="date_issued">{{ row.Date }}</td>
            <td class="date_cleared">{% if "Cleared" in row %}{% if row.Cleared|lower == "y" %}{{ row.Date }}{% endif %}{% else %}{{ row.Date }}{% endif %}</td>
            <td class="amount {% if row.Amount|parse_float < 0.0 %}debit{% else %}credit{% endif %}" >{{ row.Amount }}</td>
            <td class="bank_code">{{ row.Subcategory }}</td>
            <td class="bank_number">{{ row.Number }}</td>
            <td class="bank_memo">{{ row.Memo }}</td>
            <td class="comment"><input name="comment" value="{{ row.Comment }}"></td>
            <td class="category">
                <!-- {{ row.Category|lower }} -->
              <select name="category" onchange="wsrc.admin.accounts.on('handle_upload_data_changed')">
                <option value="">-</option>
{% for category in categories %}
                <option value="{{ category.id }}" {% if category.name|lower == row.Category|lower %}selected="selected"{% endif %}>{{ category.description }}</option>
{% endfor %}
              </select>
            </td>
            <td class="duplicate"><input type="checkbox" name="duplicate" {% if  row.x_duplicate %}checked="checked"{% endif %}  onchange="wsrc.admin.accounts.on('handle_upload_data_changed')"></td>
          </tr>
{% endif %}
{% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div id="swing-transaction-dialog" title="Balancing Transaction">
    <form>
      <fieldset class="ui-corner-all">
        <div class="ui-field-contain">
          <label for="swing_from_selector">From:</label>
          <select name="from" id="swing_from_selector">
            <option value="">-</option>
            {% for category in categories %}
            <option value="{{ category.id }}">{{ category.description }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="ui-field-contain">
          <label for="swing_to_selector">To:</label>
          <select name="to" id="swing_to_selector">
            <option value="">-</option>
            {% for category in categories %}
            <option value="{{ category.id }}">{{ category.description }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="ui-field-contain">
          <label for="swing_date">Date:</label>
          <input class="datepicker datepicker-today" name="date" id="swing_date">
        </div>        
        <div class="ui-field-contain">
          <label for="swing_amount">Amount:</label>
          <input type="number" name="amount" id="swing_amount" value="0.00">
        </div>        
        <div class="ui-field-contain">
          <label for="swing_comment">Comment:</label>
          <input name="comment" id="swing_comment">
        </div>        
        <!-- Allow form submission with keyboard without duplicating the dialog button -->
        <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
      </fieldset>
    </form>
  </div>

</body>
</html>
